if(typeof(Object.create)!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}function derive(b,a){b.prototype=Object.create(a.prototype);b.prototype.constructor=b;b.Parent=a}function Event(){this._listeners=[]}Event.prototype={add:function(a){this._listeners.push(a)},notify:function(c,a){var d=this._listeners.length;for(var b=0;b<d;b++){this._listeners[b].apply(c,a)}},clear:function(){this._listeners=[]}};var waiting="waiting",kept="kept",broken="broken";function Promise(){this.state=waiting;this.data;this._onkept=new Event();this._onbroken=new Event()}Promise.prototype={kept:function(a){if(this.state==waiting){this._onkept.add(a)}else{if(this.state==kept){a(this.data)}}return this},broken:function(a){if(this.state==waiting){this._onbroken.add(a)}else{if(this.state==broken){a(this.error)}}return this},setBroken:function(){if(this.state!=waiting){throw new Error("Attempting to break a resolved promise")}this.state=broken;this._onbroken.notify(this);this._onkept.clear();this._onbroken.clear()},setData:function(a){if(this.state!=waiting){throw new Error("Attempting to keep a resolved promise")}this.data=a;this.state=kept;this._onkept.notify(this,[this.data]);this._onkept.clear();this._onbroken.clear()},bindTo:function(a){this.kept(function(b){a.setData(b)}).broken(function(){a.setBroken()})}};function fmap(a){return function(){var c=new Promise();var b=[].slice.call(arguments);function e(){if(c.state!=waiting){return}var k=true;for(var g=0;g<b.length;g++){if(b[g].state!=kept){k=false;break}}if(k){var l=[];for(var h=0;h<b.length;h++){l[h]=b[h].data}c.setData(a.apply(null,l))}}function f(){if(c.state!=waiting){return}c.setBroken()}for(var d=0;d<b.length;d++){b[d].kept(e).broken(f)}return c}}function Variable(a){this.current=a}Variable.prototype={assign:function(a){return this.current=a}};function Collection(){this._queue=[]}Collection.prototype={get:function(b){var a=new Promise();var c=this;this._enqueue(function(){var d=c._currentsCopy();b.kept(function(e){if(d[e]==null){a.setData(d[e])}else{d[e].bindTo(a)}}).broken(function(){a.setBroken()});c._dequeue()});return a},set:function(a,c){var b=this;this._enqueue(function(){a.kept(function(d){b.currents[d]=c;b._dequeue()}).broken(function(){throw new Error("Can't use broken promise as array index")})});return c},"delete":function(a,c){var b=this;this._enqueue(function(){a.kept(function(d){delete b.currents[d];b._dequeue()}).broken(function(){throw new Error("Can't use broken promise as array index")})});return c},_currentsCopy:function(){},_enqueue:function(a){this._queue.push(a);if(this._queue.length==1){this._queue[0]()}},_dequeue:function(){if(this._queue.length==0){throw new Error("Nothing to dequeue")}else{this._queue.shift();if(this._queue.length>0){this._queue[0]()}}}};function get(c,b){var a=new Promise();c.kept(function(d){d.get(b).bindTo(a)}).broken(function(){a.setBroken()});return a}function set(c,a,b){c.kept(function(d){d.set(a,b)}).broken(function(){throw new Error("Trying to set a value on a broken promise")});return b}function DynamicArray(){DynamicArray.Parent.call(this);this.currents=[]}derive(DynamicArray,Collection);DynamicArray.prototype._currentsCopy=function(){return this.currents.slice()};DynamicArray.prototype.length=function(){var a=new Promise();var b=this;this._enqueue(function(){a.setData(b.currents.length);b._dequeue()});return a};function length(b){var a=new Promise();b.kept(function(c){c.length().bindTo(a)}).broken(function(){a.setBroken()});return a}function DynamicObject(){DynamicObject.Parent.call(this);this.currents={}}derive(DynamicObject,Collection);DynamicObject.prototype._currentsCopy=function(){var b={};for(var a in this.currents){b[a]=this.currents[a]}return b};var eq=fmap(function(b,a){return b==a});var neq=fmap(function(b,a){return b!=a});var lt=fmap(function(b,a){return b<a});var lteq=fmap(function(b,a){return b<=a});var gt=fmap(function(b,a){return b>a});var gteq=fmap(function(b,a){return b>=a});var add=fmap(function(){var a=arguments[0];for(var b=1;b<arguments.length;b++){a+=arguments[b]}return a});var mult=fmap(function(){var a=arguments[0];for(var b=1;b<arguments.length;b++){a*=arguments[b]}return a});var inc=fmap(function(b){return ++b});var dec=fmap(function(b){return --b});function branchNow(h,f,e,a){var c=[];var d;for(var g=0;g<a.length;g++){d=c[g]=[];for(var b=0;b<f.length;b++){d[b]=new Variable(f[b].current)}a[g].apply(null,d)}for(var b=0;b<f.length;b++){f[b].assign(new Promise())}h.kept(function(k){d=c[e(k)];for(var j=0;j<f.length;j++){d[j].current.bindTo(f[j].current)}}).broken(function(){throw new Error("Can't use broken promise as predicate")})}function ifelseNow(a,d,b,c){branchNow(a,d,function(e){return e?1:0},[c,b])}function ifNow(a,c,b){branchNow(a,c,function(d){return d?1:0},[function(){},b])}function switchNow(h,e,d,f){var a=[];var b={};var g=0;a[g++]=f;for(var c in d){b[c]=g;a[g++]=d[c]}branchNow(h,e,function(i){return b[i]},a)}function branchLater(f,e,d,a){var c=[];for(var b=0;b<e.length;b++){c[b]=new Variable(e[b].current);e[b].assign(new Promise())}f.kept(function(h){a[d(h)].apply(null,c);for(var g=0;g<e.length;g++){c[g].current.bindTo(e[g].current)}}).broken(function(){throw new Error("Can't use broken promise as predicate")})}function ifelseLater(a,d,b,c){branchLater(a,d,function(e){return e?1:0},[c,b])}function ifLater(a,c,b){branchLater(a,c,function(d){return d?1:0},[function(){},b])}function switchLater(h,e,d,f){var a=[];var b={};var g=0;a[g++]=f;for(var c in d){b[c]=g;a[g++]=d[c]}branchLater(h,e,function(i){return b[i]},a)}function loopWhile(e,l,k,b){var f,a=0;var c=[],j=[],d=[],h=[];for(f=0;f<e.length;f++){j[f]=new Variable(e[f].current);e[f].assign(new Promise());e[f].allVarsIndex=a;d[a]=e[f];h[a]=j[f];a+=1}for(f=0;f<k.length;f++){if("allVarsIndex" in k[f]){c[f]=h[k[f].allVarsIndex]}else{c[f]=new Variable(k[f].current);k[f].assign(new Promise());d[a]=k[f];h[a]=c[f];a+=1}}for(f=0;f<e.length;f++){delete e[f].allVarsIndex}function g(){var i=l.apply(null,j);i.kept(function(o){if(o){var n=b.apply(null,c);if(n==null){g()}else{n.kept(function(q){if(!q){g()}else{for(var p=0;p<d.length;p++){h[p].current.bindTo(d[p].current)}}}).broken(function(){throw new Error("Broken promise in loop break")})}}else{for(var m=0;m<d.length;m++){h[m].current.bindTo(d[m].current)}}}).broken(function(){throw new Error("Broken promise in a loop condition")})}g()}function nowData(a){var b=new Promise();b.setData(a);return b}function laterData(b,a){var c=new Promise();setTimeout(function(){c.setData(b)},a);return c}function laterBreak(a){var b=new Promise();setTimeout(function(){b.setBroken()},a);return b}function inputData(d,h){var b=new Promise();var g=document.createElement("DIV");var a=document.createElement("INPUT");a.type="text";g.appendChild(a);var c=document.createElement("BUTTON");c.appendChild(document.createTextNode(">"));g.appendChild(c);var f=document.createTextNode("...");d.kept(function(i){f.data=i}).broken(function(){f.data="!!"});g.appendChild(f);document.body.appendChild(g);a.focus();c.addEventListener("click",function e(){b.setData(h?h(a.value):a.value);a.disabled=true;c.disabled=true;c.removeEventListener("click",e)});return b};